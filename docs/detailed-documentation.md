# 游戏宏工具 - 详细功能说明文档

## 项目概述

本项目是一个基于AutoHotkey v2开发的游戏宏工具，专门用于游戏的自动化操作和技能管理。工具采用模块化设计，具备完整的UI界面、多种引擎支持、灵活的配置系统以及高效的工作池管理。

## 核心架构

### 主程序框架 (Main.ahk)

主程序作为整个系统的入口，负责：

- **权限检查**: 自动检查并请求管理员权限
- **单实例控制**: 确保程序只有一个实例运行
- **工作目录**: 设置程序运行目录
- **坐标模式**: 配置全局坐标使用模式
- **托盘图标**: 提供系统托盘图标和菜单
- **模块加载**: 动态包含所有功能模块
- **初始化流程**: 按序初始化各模块 (AppConfig → Lang → Core → Dup)

### 全局状态管理

系统通过全局Map对象 `App` 管理所有核心状态：

```autohotkey
App := {
    ProfileData: {},     // 用户配置数据
    BoundHotkeys: {},    // 已绑定热键
    UI: {},             // UI组件状态
    // ... 其他全局状态
}
```

## 引擎模块详解

### 1. 技能轮换引擎 (Rotation.ahk)

**功能特点**:
- **多轨道轮换**: 支持定义多个技能轨道
- **Gate条件系统**: 根据条件动态跳轨
- **起手技能**: 专门的起手技能释放
- **轨道轮换**: 智能技能序列切换
- **黑框防抖**: 防止频繁触发
- **BusyWindow管理**: 检测窗口忙碌状态

**核心函数**:
- `Rotation_InitFromProfile()`: 从配置文件初始化
- `Rotation_Reset()`: 重置轮换状态
- `Rotation_GetNextSkill()`: 获取下一个技能
- `Rotation_CheckGateConditions()`: 检查跳轨条件

### 2. 规则引擎 (RuleEngine.ahk)

**功能特点**:
- **条件判断**: 支持复杂的技能释放条件
- **规则过滤**: 灵活的规则过滤机制
- **计数模式**: 技能使用次数统计
- **调试日志**: 详细的执行日志记录
- **屏幕提示**: 可视化反馈显示

**规则数据结构**:
```autohotkey
{
    ID: "rule_id",
    Name: "规则名称",
    Enabled: true,
    Conditions: [...],  // 条件列表
    Actions: [...]      // 动作列表
}
```

### 3. Buff续时引擎 (BuffEngine.ahk)

**功能特点**:
- **优先续时**: 智能的Buff优先级管理
- **多线程**: 支持多线程并发处理
- **技能检测**: 自动检测技能就绪状态
- **计时跟踪**: 精确的Buff持续时间管理

**核心流程**:
1. 检测当前Buff状态
2. 识别需要续时的Buff
3. 执行续时技能
4. 跟踪技能使用并重置计时

### 4. 屏幕捕获引擎 (Dup.ahk)

**功能特点**:
- **DXGI复制**: 高效的屏幕复制技术
- **多显示器**: 支持多显示器环境
- **错误处理**: 完善的错误恢复机制
- **自动初始化**: 智能初始化流程

**捕获方式**:
- **DXGI模式**: 高性能屏幕复制（推荐）
- **GDI模式**: 兼容性备用方案

### 5. 像素检测引擎 (Pixel.ahk)

**功能特点**:
- **颜色转换**: RGB与十六进制颜色转换
- **颜色匹配**: 容差范围内的颜色匹配
- **帧级缓存**: 多层缓存机制提高性能
- **ROI快照**: 区域兴趣快照功能

**缓存优先级**:
1. DXGI帧缓存（最高性能）
2. ROI缓存（特定区域）
3. GDI快照（兼容性）

### 6. 轮询引擎 (Poller.ahk)

**功能特点**:
- **优先级调度**: 按优先级执行各引擎
- **帧级处理**: 高频率的帧处理
- **状态检查**: 实时检查各模块状态
- **故障恢复**: 自动故障检测与恢复

**执行顺序**:
1. **Buff引擎**: 优先处理Buff续时
2. **轮换/规则引擎**: 处理主要技能逻辑
3. **默认技能**: 兜底技能执行
4. **状态重置**: 清理临时状态

## UI框架系统

### 1. UI框架核心 (UI_Framework.ahk)

**页面管理**:
- **页面注册**: `UI_RegisterPage()`
- **页面切换**: `UI_SwitchPage()`
- **生命周期**: `OnEnter()` / `OnLeave()` 事件
- **参数适配**: `UI_Call0Or1()` 智能函数调用

**导航系统**:
```autohotkey
UI_NavMap := {
    "overview": "概览页面",
    "profile": "角色配置",
    "skills": "技能管理",
    // ... 更多页面
}
```

### 2. UI布局系统 (UI_Layout.ahk)

**布局功能**:
- **DPI适配**: 自动DPI缩放计算
- **Tab布局**: `UI_TabPageRect()` 计算内容区域
- **强制重绘**: `UI_ForceRedrawAll()` 刷新所有窗口
- **安全移动**: `UI_MoveSafe()` 防止控件重叠

### 3. UI Shell主框架 (UI_Shell.ahk)

**主界面特点**:
- **左侧导航**: TreeView导航菜单
- **右侧面板**: 动态内容显示区
- **多页面支持**: 注册了10+个功能页面
- **响应式设计**: 窗口大小自适应

## 核心页面模块

### 1. 角色配置页面 (Page_Profile.ahk)

**功能模块**:
- **配置文件管理**: 新建/复制/删除配置文件
- **热键设置**: 开始/停止热键绑定
- **轮询配置**: 轮询间隔和全局延迟设置
- **技能配置**: 默认技能和Hold时间设置

**界面组件**:
- GroupBox分组框
- DropDownList下拉列表
- Button按钮操作
- Hotkey热键控件
- Edit编辑框

### 2. 技能管理页面 (Page_Skills.ahk)

**技能数据结构**:
```autohotkey
{
    ID: 1,
    Name: "技能名称", 
    Key: "按键",
    X: 100,     // X坐标
    Y: 200,     // Y坐标
    Color: "0xFF0000",  // 颜色值
    Tolerance: 10,      // 颜色容差
    CastMs: 500,        // 施法时间
    HoldMs: 100,        // 按键持续时间
    // ... 其他属性
}
```

**管理功能**:
- **技能列表**: ListView展示技能数据
- **CRUD操作**: 增加/编辑/删除/测试技能
- **批量操作**: 保存和刷新技能列表
- **属性配置**: 坐标、颜色、容差等参数

### 3. 规则摘要页面 (Page_Rules_Summary.ahk)

**规则统计**:
- **总数统计**: 规则总数和启用状态
- **线程分布**: 按线程分组的规则统计
- **触发记录**: 最近触发时间记录

**规则列表**:
- **ID**: 规则唯一标识
- **状态**: 启用/禁用状态
- **名称**: 规则描述名称
- **逻辑**: 规则类型和复杂度
- **条件/动作数**: 规则组成部分统计

## 配置和存储系统

### 1. 应用配置 (AppConfig.ahk)

**配置管理**:
- **配置目录**: 自动创建配置目录
- **语言设置**: 程序语言偏好管理
- **持久化**: INI文件格式存储

**核心函数**:
- `AppConfig_Init()`: 初始化配置
- `AppConfig_Get()`: 获取配置值
- `AppConfig_Set()`: 设置配置值
- `AppConfig_Save()`: 保存配置

### 2. 存储管理器 (Storage.ahk)

**功能特点**:
- **配置文件管理**: 列出和管理所有配置文件
- **轨道配置**: 详细的旋转轨道存储
- **Gate配置**: 条件跳轨配置管理
- **完整Profile**: 用户配置的完整序列化

**文件结构**:
```
配置文件.ini
├── [Hotkeys]     # 热键配置
├── [Skills]      # 技能数据
├── [Spots]       # 点位数据
├── [Buffs]       # Buff配置
├── [Rules]       # 规则配置
└── [Rotation]    # 轮换配置
```

### 3. 导出系统 (Exporter.ahk)

**导出内容**:
- **主脚本**: 完整的脚本文件
- **配置**: 指定的用户配置文件
- **WorkerHost**: 外部工作进程(EXE/AHK)
- **说明文档**: 使用说明和部署指南

## 工作池系统

### 1. 工作池管理器 (WorkerPool.ahk)

**核心特点**:
- **FF-ONLY模式**: Fire-and-Forget一次性发送
- **进程管理**: 动态创建和销毁外部进程
- **Cast锁**: 防止重复施法的线程锁
- **延迟发送**: 支持按键延迟和持续时间

**发送机制**:
```autohotkey
// 核心发送函数
WorkerPool_SendSkillIndex(threadId, idx, src, holdOverride)
```

**特性**:
- **优先级处理**: 按线程优先级调度
- **冷却时间**: 全局技能冷却间隔
- **状态跟踪**: 实时跟踪发送状态
- **错误恢复**: 自动重试和错误处理

### 2. 工作宿主 (WorkerHost.ahk)

**执行模式**:
- **一次性模式**: `--fire key delay hold`
- **常驻模式**: 通过WM_COPYDATA通信

**发送类型**:
- **功能键**: F1-F24, Tab, Enter等
- **修饰键**: Ctrl, Alt, Shift, Win组合
- **鼠标键**: 左键、右键、中键、侧键等
- **特殊键**: 方向键、功能键等

### 3. 热键管理 (Hotkeys.ahk)

**绑定特性**:
- **鼠标穿透**: 鼠标键自动添加"~"前缀
- **动态切换**: 实时更换热键绑定
- **状态切换**: 开始/停止状态切换

## 运行时组件

### 1. 计数器系统 (Counters.ahk)

**统计功能**:
- **技能计数**: 按技能索引统计使用次数
- **全局存储**: Map结构存储计数状态
- **重置功能**: 支持单个或批量重置

**核心函数**:
- `Counters_Inc()`: 增加计数
- `Counters_Get()`: 获取计数
- `Counters_Reset()`: 重置计数
- `Counters_ResetMany()`: 批量重置

### 2. 工具函数 (Utils.ahk)

**通用工具**:
- `Notify()`: 屏幕提示函数
- `Confirm()`: 确认对话框
- `UI_ActivateMain()`: 激活主窗口

## 多语言支持

### 语言系统 (Lang.ahk)

**支持特性**:
- **动态加载**: 运行时语言包加载
- **回退机制**: 语言缺失时的默认处理
- **扩展性**: 易于添加新语言支持

## 工具页面

### 1. 快速工具 (Page_Tools_Quick.ahk)

**功能模块**:
- **快速操作**: 常用功能快速访问
- **状态查看**: 实时系统状态显示
- **快捷命令**: 常用命令的快捷方式

### 2. IO工具 (Page_Tools_IO.ahk)

**输入输出**:
- **导入导出**: 配置数据的导入导出
- **数据验证**: 配置文件格式验证
- **批量处理**: 批量操作和管理功能

## 技术特性

### 1. 性能优化

- **多层缓存**: DXGI→ROI→GDI三级缓存
- **异步处理**: 多线程并发处理
- **智能轮询**: 优先级驱动的轮询机制
- **内存管理**: Map对象的高效内存使用

### 2. 错误处理

- **异常捕获**: 全面的异常处理机制
- **日志记录**: 详细的错误日志记录
- **自动恢复**: 故障后的自动恢复机制
- **用户反馈**: 直观的错误提示

### 3. 扩展性

- **模块化设计**: 清晰的模块分离
- **插件架构**: 支持功能模块的动态加载
- **配置驱动**: 通过配置文件控制行为
- **API接口**: 公开的API接口供扩展

## 部署说明

### 1. 文件结构
```
游戏宏工具/
├── Main.ahk              # 主程序
├── modules/
│   ├── core/             # 核心模块
│   ├── engines/          # 引擎模块
│   ├── ui/               # UI模块
│   ├── workers/          # 工作池
│   ├── runtime/          # 运行时
│   └── tools/            # 工具模块
├── configs/              # 配置文件目录
├── exports/              # 导出目录
└── docs/                 # 文档目录
```

### 2. 运行要求

- **操作系统**: Windows 10/11
- **运行时**: AutoHotkey v2
- **权限**: 管理员权限（推荐）
- **依赖**: DXGI支持（Windows 8+）

### 3. 配置建议

- **分辨率**: 1920x1080或更高
- **颜色深度**: 32位真彩色
- **显卡**: 支持DirectX 11
- **内存**: 4GB以上可用内存

## 总结

本游戏宏工具是一个功能完整、架构清晰的自动化工具。通过模块化设计实现了高度的灵活性和可扩展性，支持复杂的游戏自动化需求。工具提供了直观的用户界面、强大的引擎系统和可靠的性能表现，是游戏自动化领域的优秀解决方案。

**主要优势**:
- ✅ 完整的UI界面，操作简单直观
- ✅ 多引擎协同，智能化程度高  
- ✅ 模块化架构，维护性良好
- ✅ 高性能优化，响应速度快
- ✅ 配置灵活，支持个性化定制
- ✅ 错误处理完善，稳定可靠

**适用场景**:
- 技能轮换和连招自动化
- Buff管理和续时控制
- 规则化的技能释放
- 像素检测和位置操作
- 多线程并发处理需求

---

*本文档基于源代码详细分析生成，涵盖了项目的所有核心功能和架构设计。*