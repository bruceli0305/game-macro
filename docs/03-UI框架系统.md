# UI框架系统 - User Interface Framework Documentation

## 概述

UI框架是游戏宏工具的用户界面核心，负责构建和管理整个应用程序的用户交互界面。框架采用模块化设计，提供了完整的页面管理系统、布局辅助工具和主界面框架，支持多种功能页面的动态加载和切换。

## UI框架架构

### 核心模块组成

1. **UI_Framework.ahk** - 页面管理框架核心
2. **UI_Layout.ahk** - UI布局辅助功能
3. **UI_Shell.ahk** - 主界面框架实现
4. **pages/** - 功能页面模块目录

### 框架层次结构

```
UI框架系统
├── UI_Framework (页面管理核心)
│   ├── 页面注册/切换
│   ├── 生命周期管理  
│   ├── 事件路由
│   └── 状态管理
├── UI_Layout (布局辅助)
│   ├── DPI缩放计算
│   ├── 区域计算
│   ├── 控件管理
│   └── 重绘控制
├── UI_Shell (主界面)
│   ├── 窗口框架
│   ├── 导航菜单
│   ├── 内容面板
│   └── 状态栏
└── Pages (功能页面)
    ├── 角色配置页
    ├── 技能管理页
    ├── 规则配置页
    └── ...更多页面
```

## 1. UI框架核心 - UI_Framework.ahk

### 核心功能

UI框架核心负责页面的注册、管理和切换，提供完整的页面生命周期管理。

**主要特性**:
- **页面注册**: 支持动态页面注册
- **页面切换**: 流畅的页面切换机制
- **生命周期**: OnEnter/OnLeave事件管理
- **事件路由**: 智能的事件分发机制
- **参数适配**: 灵活的函数调用适配

### 核心数据结构

```autohotkey
; UI框架全局状态
global UI := {
    CurrentPage: "",        // 当前页面标识
    Pages: Map(),          // 已注册页面映射
    MainWindow: 0,         // 主窗口句柄
    ContentArea: {         // 内容区域坐标
        X: 200,
        Y: 30,
        Width: 800,
        Height: 600
    },
    State: Map(),          // 框架状态
    Events: Map()          // 事件映射
}

; 页面信息结构
PageInfo := {
    Name: "页面名称",       // 页面显示名称
    FilePath: "",          // 页面文件路径
    OnEnter: "",           // 进入回调函数
    OnLeave: "",           // 离开回调函数
    Build: "",             // 构建函数
    Layout: "",            // 布局函数
    Data: Map(),           // 页面数据
    Enabled: true,         // 是否启用
    Hidden: false          // 是否隐藏
}
```

### 核心函数详解

#### 页面注册

**UI_RegisterPage()**
```autohotkey
; 注册新页面
UI_RegisterPage(pageId, pageInfo) {
    global UI
    
    if !IsObject(pageInfo) {
        UI_Log("页面信息无效: " pageId)
        return false
    }
    
    ; 验证必要字段
    if !pageInfo.Has("FilePath") {
        UI_Log("页面文件路径缺失: " pageId)
        return false
    }
    
    ; 创建页面信息
    info := {
        Name: pageInfo.Has("Name") ? pageInfo["Name"] : pageId,
        FilePath: pageInfo["FilePath"],
        OnEnter: pageInfo.Has("OnEnter") ? pageInfo["OnEnter"] : "",
        OnLeave: pageInfo.Has("OnLeave") ? pageInfo["OnLeave"] : "",
        Build: pageInfo.Has("Build") ? pageInfo["Build"] : "",
        Layout: pageInfo.Has("Layout") ? pageInfo["Layout"] : "",
        Data: pageInfo.Has("Data") ? pageInfo["Data"] : Map(),
        Enabled: pageInfo.Has("Enabled") ? pageInfo["Enabled"] : true,
        Hidden: pageInfo.Has("Hidden") ? pageInfo["Hidden"] : false
    }
    
    ; 注册页面
    UI.Pages.Set(pageId, info)
    
    UI_Log("页面注册成功: " pageId " -> " info.FilePath)
    return true
}
```

#### 页面切换

**UI_SwitchPage()**
```autohotkey
; 切换到指定页面
UI_SwitchPage(pageId) {
    global UI
    
    ; 检查页面是否存在
    if !UI.Pages.Has(pageId) {
        UI_Log("页面不存在: " pageId)
        return false
    }
    
    page := UI.Pages[pageId]
    
    ; 检查页面是否可用
    if !page.Enabled {
        UI_Log("页面已禁用: " pageId)
        return false
    }
    
    ; 触发当前页面的OnLeave事件
    if (UI.CurrentPage != "" && UI.Pages.Has(UI.CurrentPage)) {
        currentPage := UI.Pages[UI.CurrentPage]
        if (currentPage.OnLeave != "") {
            try %currentPage.OnLeave%()
        }
    }
    
    ; 更新当前页面
    oldPage := UI.CurrentPage
    UI.CurrentPage := pageId
    
    ; 加载页面内容
    success := UI_LoadPageContent(pageId)
    
    if success {
        ; 触发新页面的OnEnter事件
        if (page.OnEnter != "") {
            try %page.OnEnter%()
        }
        
        UI_Log("页面切换成功: " oldPage " -> " pageId)
        UI_UpdateWindowTitle()
        return true
    } else {
        ; 恢复原页面
        UI.CurrentPage := oldPage
        UI_Log("页面切换失败: " pageId)
        return false
    }
}
```

#### 页面内容加载

**UI_LoadPageContent()**
```autohotkey
; 加载页面内容
UI_LoadPageContent(pageId) {
    global UI
    
    page := UI.Pages[pageId]
    
    try {
        ; 包含页面文件
        #Include % page.FilePath
        
        ; 构建页面
        if (page.Build != "") {
            result := %page.Build%(UI.ContentArea)
            if (result == false) {
                UI_Log("页面构建失败: " pageId)
                return false
            }
        }
        
        ; 执行布局
        if (page.Layout != "") {
            %page.Layout%()
        }
        
        return true
    } catch error {
        UI_Log("页面加载异常: " pageId " - " error.message)
        return false
    }
}
```

#### 事件处理系统

**UI_Call0Or1()**
```autohotkey
; 智能函数调用（0或1参数）
UI_Call0Or1(funcName, param := "") {
    if (funcName == "")
        return false
    
    ; 尝试无参数调用
    try {
        %funcName%()
        return true
    } catch Error as err1 {
        ; 尝试带参数调用
        try {
            %funcName%(param)
            return true
        } catch Error as err2 {
            UI_Log("函数调用失败: " funcName " - " err1.message " | " err2.message)
            return false
        }
    }
}
```

### 生命周期管理

**页面生命周期**:
```autohotkey
; 页面进入事件
UI_OnPageEnter(pageId) {
    global UI
    
    page := UI.Pages[pageId]
    
    ; 保存页面状态
    UI.State["LastPage"] := UI.CurrentPage
    UI.State["PageEnterTime"] := A_TickCount
    
    ; 执行页面特定进入逻辑
    if (page.OnEnter != "") {
        UI_Call0Or1(page.OnEnter)
    }
    
    ; 更新导航状态
    UI_UpdateNavigation(pageId)
}

; 页面离开事件
UI_OnPageLeave(pageId) {
    global UI
    
    page := UI.Pages[pageId]
    
    ; 保存页面状态
    UI.State["PageLeaveTime"] := A_TickCount
    
    ; 执行页面特定离开逻辑
    if (page.OnLeave != "") {
        UI_Call0Or1(page.OnLeave)
    }
    
    ; 清理页面资源
    UI_CleanupPageResources(pageId)
}
```

## 2. UI布局系统 - UI_Layout.ahk

### 核心功能

UI布局系统提供DPI感知、区域计算、控件管理和重绘控制等布局辅助功能。

**主要特性**:
- **DPI缩放**: 自动DPI检测和缩放计算
- **Tab布局**: 智能Tab页面区域计算
- **强制重绘**: 批量控件重绘管理
- **安全移动**: 防止控件重叠的安全移动

### 核心函数详解

#### DPI缩放计算

**UI_GetScale()**
```autohotkey
; 获取DPI缩放比例
UI_GetScale() {
    ; 检测系统DPI设置
    try {
        ; 通过GDI+获取DPI
        dpi := DllCall("gdi32.dll\GetDeviceCaps", "Ptr", DllCall("GetDC", "Ptr", 0), "Int", 88) ; LOGPIXELSX
        scale := dpi / 96.0  ; 标准DPI为96
    } catch {
        ; 降级方案：使用系统参数
        scale := 1.0
    }
    
    return scale
}

; DPI感知的坐标计算
UI_CalcDPIAwarePos(x, y) {
    scale := UI_GetScale()
    return { X: Round(x * scale), Y: Round(y * scale) }
}
```

#### Tab页面区域计算

**UI_TabPageRect()**
```autohotkey
; 计算Tab页面的内容区域
UI_TabPageRect(tabControl, parentWindow) {
    try {
        ; 获取Tab控件位置
        WinGetPos(&tabX, &tabY, &tabW, &tabH, tabControl)
        
        ; 获取窗口客户区
        WinGetClientPos(&winX, &winY, &winW, &winH, parentWindow)
        
        ; 计算内容区域（排除Tab标题栏）
        contentX := tabX + 5
        contentY := tabY + 25  ; Tab标题栏高度
        contentW := tabW - 10
        contentH := tabH - 30  ; 扣除标题栏和边距
        
        return {
            X: contentX,
            Y: contentY, 
            Width: contentW,
            Height: contentH
        }
    } catch {
        ; 默认区域
        return { X: 200, Y: 30, Width: 800, Height: 600 }
    }
}
```

#### 批量重绘

**UI_ForceRedrawAll()**
```autohotkey
; 强制重绘所有窗口
UI_ForceRedrawAll() {
    global UI
    
    if !UI.Has("MainWindow") || !UI.MainWindow
        return
    
    ; 发送WM_PAINT消息
    DllCall("user32.dll\InvalidateRect", "Ptr", UI.MainWindow, "Ptr", 0, "Int", true)
    DllCall("user32.dll\UpdateWindow", "Ptr", UI.MainWindow)
    
    ; 强制重绘所有子控件
    UI_RedrawAllChildControls(UI.MainWindow)
}

UI_RedrawAllChildControls(parentHWND) {
    ; 枚举所有子控件
    childEnum := WinGetControls(parentHWND)
    
    for control in childEnum {
        try {
            ; 获取控件句柄
            hwnd := ControlGetHwnd(control, parentHWND)
            if (hwnd) {
                ; 强制重绘
                DllCall("user32.dll\InvalidateRect", "Ptr", hwnd, "Ptr", 0, "Int", true)
                DllCall("user32.dll\UpdateWindow", "Ptr", hwnd)
            }
        } catch {
            ; 忽略单个控件的重绘错误
        }
    }
}
```

#### 安全移动控件

**UI_MoveSafe()**
```autohotkey
; 安全移动控件（避免重叠）
UI_MoveSafe(control, newX, newY, parentWindow := "") {
    if (parentWindow == "") {
        parentWindow := UI.MainWindow
    }
    
    ; 获取控件当前位置
    try {
        WinGetPos(&oldX, &oldY, &width, &height, control, parentWindow)
    } catch {
        return false
    }
    
    ; 检查目标位置是否有效
    if !UI_IsValidPosition(newX, newY, width, height, parentWindow) {
        UI_Log("目标位置无效: " newX "," newY)
        return false
    }
    
    ; 执行移动
    try {
        ControlMove(newX, newY, width, height, control, parentWindow)
        return true
    } catch error {
        UI_Log("控件移动失败: " error.message)
        return false
    }
}

; 位置有效性检查
UI_IsValidPosition(x, y, width, height, parentWindow) {
    ; 获取父窗口大小
    try {
        WinGetClientPos(&pw, &ph, &pwidth, &pheight, parentWindow)
    } catch {
        return false
    }
    
    ; 检查边界
    if (x < 0 || y < 0 || x + width > pwidth || y + height > pheight) {
        return false
    }
    
    ; 检查与其他控件的冲突
    return !UI_HasControlConflict(x, y, width, height, parentWindow)
}
```

## 3. UI Shell主框架 - UI_Shell.ahk

### 核心功能

UI Shell实现主界面框架，包含窗口框架、导航菜单、内容面板和状态栏等核心组件。

**主要特性**:
- **左侧导航**: TreeView导航菜单
- **右侧面板**: 动态内容显示区域  
- **状态栏**: 实时状态信息显示
- **菜单系统**: 完整的菜单支持

### 核心数据结构

```autohotkey
; 主界面状态
global UI := {
    Main: {                // 主界面
        Window: 0,         // 主窗口句柄
        Gui: 0,           // GUI对象
        Width: 1024,      // 窗口宽度
        Height: 768,      // 窗口高度
        Minimized: false  // 最小化状态
    },
    Navigation: {          // 导航区域
        TreeView: 0,       // 导航树控件
        Width: 200,        // 导航区域宽度
        Panel: {}         // 导航面板信息
    },
    Content: {             // 内容区域
        Panel: 0,          // 内容面板控件
        Area: {},          // 内容区域坐标
        CurrentPage: ""    // 当前页面
    },
    StatusBar: {           // 状态栏
        Control: 0,        // 状态栏控件
        Parts: []          // 状态栏分区
    }
}

; 导航映射
UI_NavMap := {
    "overview": {
        Text: "概览配置",
        Page: "profile_overview",
        Icon: "overview",
        Enabled: true
    },
    "profile": {
        Text: "角色配置", 
        Page: "page_profile",
        Icon: "profile",
        Enabled: true
    },
    "skills": {
        Text: "技能管理",
        Page: "page_skills", 
        Icon: "skills",
        Enabled: true
    },
    "spots": {
        Text: "点位管理",
        Page: "page_spots",
        Icon: "spots", 
        Enabled: true
    },
    "rules": {
        Text: "规则配置",
        Page: "page_rules",
        Icon: "rules",
        Enabled: true
    },
    "buffs": {
        Text: "BUFF管理",
        Page: "page_buffs",
        Icon: "buffs",
        Enabled: true
    },
    "threads": {
        Text: "线程管理", 
        Page: "page_threads",
        Icon: "threads",
        Enabled: true
    },
    "rotation": {
        Text: "轮换配置",
        Page: "page_rotation",
        Icon: "rotation",
        Enabled: true
    },
    "tools": {
        Text: "工具页面",
        Page: "tools_main",
        Icon: "tools",
        Enabled: true,
        SubItems: {
            "quick": { Text: "快速工具", Page: "tools_quick" },
            "io": { Text: "IO工具", Page: "tools_io" }
        }
    },
    "settings": {
        Text: "系统设置",
        Page: "settings_main", 
        Icon: "settings",
        Enabled: true,
        SubItems: {
            "about": { Text: "关于", Page: "settings_about" },
            "language": { Text: "语言", Page: "settings_language" }
        }
    }
}
```

### 核心函数详解

#### 主窗口创建

**UI_ShowMain()**
```autohotkey
; 显示主界面
UI_ShowMain() {
    global UI
    
    ; 创建主窗口GUI
    UI.Main.Gui := Gui("+Resize+MinSize800x600", "游戏宏工具 v1.0")
    
    ; 设置窗口图标
    try {
        iconPath := A_ScriptDir "\assets\icon.ico"
        if FileExist(iconPath) {
            UI.Main.Gui.OnEvent("Close", UI_OnMainClose)
            UI.Main.Gui.OnEvent("Size", UI_OnMainResize)
        }
    } catch {
        ; 图标设置失败不影响主功能
    }
    
    ; 创建导航区域
    UI_CreateNavigation()
    
    ; 创建内容区域
    UI_CreateContentArea()
    
    ; 创建状态栏
    UI_CreateStatusBar()
    
    ; 注册所有页面
    UI_RegisterAllPages()
    
    ; 显示窗口
    UI.Main.Gui.Show("w1024 h768 Center")
    UI.Main.Window := UI.Main.Gui.Hwnd
    
    ; 默认显示概览页面
    UI_SwitchPage("overview")
    
    UI_Log("主界面创建成功")
}

; 创建导航区域
UI_CreateNavigation() {
    global UI
    
    ; 左侧导航面板
    navGui := Gui("-Caption +Parent" UI.Main.Gui.Hwnd, "")
    navGui.BackColor := 0xF0F0F0
    
    ; 创建TreeView导航菜单
    treeView := navGui.Add("TreeView", "x10 y10 w180 h700")
    UI.Navigation.TreeView := treeView
    
    ; 填充导航菜单
    UI_PopulateNavigation()
    
    ; 设置TreeView事件
    treeView.OnEvent("Change", UI_OnNavChange)
    
    navGui.Show("x0 y0 w200 h720")
    UI.Navigation.Panel.Gui := navGui
}
```

#### 导航菜单填充

**UI_PopulateNavigation()**
```autohotkey
; 填充导航菜单
UI_PopulateNavigation() {
    global UI, UI_NavMap
    
    treeView := UI.Navigation.TreeView
    
    ; 清空现有项目
    try {
        treeView.Delete()
    } catch {
        ; 忽略清空错误
    }
    
    ; 添加主导航项
    for navId, navInfo in UI_NavMap {
        if !navInfo.Enabled
            continue
        
        ; 添加主项
        itemId := treeView.Add(navInfo.Text)
        
        ; 添加子项（如果有）
        if navInfo.Has("SubItems") {
            for subId, subInfo in navInfo.SubItems {
                if !subInfo.Enabled
                    continue
                    
                childId := treeView.Add(subInfo.Text, itemId)
                
                ; 存储映射信息
                treeView.Modify(childId, "", subInfo.Text, subInfo.Page, navId, subId)
            }
        } else {
            ; 存储主项映射信息
            treeView.Modify(itemId, "", navInfo.Text, navInfo.Page, navId, "")
        }
    }
}

; 导航项数据结构
; treeView.Modify(itemId, "", displayText, pageId, parentId, subId)
```

#### 导航事件处理

**UI_OnNavChange()**
```autohotkey
; 导航选择变更事件
UI_OnNavChange(this, selectedItem) {
    try {
        ; 获取选中项信息
        selectedText := this.GetText(selectedItem)
        
        ; 从项数据中获取页面ID
        text, pageId, parentId, subId := this.GetContent(selectedItem)
        
        if (pageId != "") {
            ; 切换到对应页面
            UI_SwitchPage(pageId)
            
            ; 更新状态栏
            UI_UpdateStatusBar("导航至: " selectedText)
        }
    } catch error {
        UI_Log("导航切换失败: " error.message)
    }
}
```

#### 内容区域管理

**UI_CreateContentArea()**
```autohotkey
; 创建内容区域
UI_CreateContentArea() {
    global UI
    
    ; 创建内容面板
    contentGui := Gui("+Parent" UI.Main.Gui.Hwnd, "")
    contentGui.BackColor := 0xFFFFFF
    
    ; 计算内容区域位置
    contentX := UI.Navigation.Width + 10
    contentY := 10
    contentWidth := UI.Main.Width - contentX - 10
    contentHeight := UI.Main.Height - 70  ; 扣除状态栏
    
    ; 保存内容区域信息
    UI.Content.Area := {
        X: contentX,
        Y: contentY,
        Width: contentWidth,
        Height: contentHeight
    }
    
    contentGui.Show("x" contentX " y" contentY " w" contentWidth " h" contentHeight)
    UI.Content.Panel := contentGui
}

; 清理内容区域
UI_CleanupContent() {
    global UI
    
    if UI.Content.Panel {
        try {
            UI.Content.Panel.Destroy()
            UI.Content.Panel := 0
        } catch {
            UI_Log("内容面板清理失败")
        }
    }
}
```

#### 状态栏管理

**UI_CreateStatusBar()**
```autohotkey
; 创建状态栏
UI_CreateStatusBar() {
    global UI
    
    ; 创建状态栏窗口
    statusBar := DllCall("CreateWindowExW"
        , "UInt", 0          ; dwExStyle
        , "WStr", "MSCTLS_STATUSBAR32"  ; lpClassName
        , "WStr", ""         ; lpWindowName  
        , "UInt", 0x56000000 ; dwStyle (WS_CHILD | WS_VISIBLE | SBARS_SIZEGRIP)
        , "Int", 0           ; x
        , "Int", UI.Main.Height - 25  ; y
        , "Int", UI.Main.Width        ; nWidth
        , "Int", 25            ; nHeight
        , "Ptr", UI.Main.Window ; hWndParent
        , "Ptr", 0             ; hMenu
        , "Ptr", 0             ; hInstance
        , "Ptr", 0             ; lpParam
        , "Ptr")
    
    if (statusBar != 0) {
        UI.StatusBar.Control := statusBar
        
        ; 初始化状态栏分区
        UI_InitStatusBarParts()
        
        ; 设置默认状态文本
        UI_SetStatusText("就绪")
    }
}

; 初始化状态栏分区
UI_InitStatusBarParts() {
    global UI
    
    ; 设置4个分区：运行状态、页面信息、系统状态、版本信息
    widths := [-1, 150, 100, 80]  ; -1表示自适应，其余为固定宽度
    
    DllCall("SendMessageW"
        , "Ptr", UI.StatusBar.Control
        , "UInt", 0x0404  ; SB_SETPARTS
        , "Ptr", widths.Length
        , "Ptr", &widths
    )
}

; 设置状态栏文本
UI_SetStatusText(text, partIndex := 0) {
    global UI
    
    if !UI.StatusBar.Control
        return
    
    ; 转换为UTF-16
    buffer := Buffer((StrLen(text) + 1) * 2, 0)
    StrPut(text, buffer, "UTF-16")
    
    DllCall("SendMessageW"
        , "Ptr", UI.StatusBar.Control
        , "UInt", 0x0401  ; SB_SETTEXTW
        , "Ptr", partIndex
        , "Ptr", buffer.Ptr
    )
}
```

#### 窗口事件处理

**UI_OnMainResize()**
```autohotkey
; 主窗口大小调整事件
UI_OnMainResize(this, minMax, width, height) {
    global UI
    
    ; 保存新尺寸
    UI.Main.Width := width
    UI.Main.Height := height
    
    if (minMax == -1)  ; 窗口被最小化
        return
    
    ; 重新布局各个区域
    UI_RelayoutAllAreas()
    
    ; 通知当前页面重新布局
    if (UI.Content.CurrentPage != "") {
        currentPage := UI.Pages[UI.Content.CurrentPage]
        if (currentPage.Layout != "") {
            try %currentPage.Layout%()
        }
    }
}

; 重新布局所有区域
UI_RelayoutAllAreas() {
    global UI
    
    ; 重新定位导航面板
    if UI.Navigation.Panel.Gui {
        UI.Navigation.Panel.Gui.Move(0, 0, UI.Navigation.Width, UI.Main.Height - 25)
    }
    
    ; 重新定位内容面板
    if UI.Content.Panel {
        newX := UI.Navigation.Width + 10
        newY := 10
        newWidth := UI.Main.Width - newX - 10
        newHeight := UI.Main.Height - 35
        
        UI.Content.Panel.Move(newX, newY, newWidth, newHeight)
        
        ; 更新内容区域信息
        UI.Content.Area.X := newX
        UI.Content.Area.Y := newY
        UI.Content.Area.Width := newWidth
        UI.Content.Area.Height := newHeight
    }
    
    ; 重新定位状态栏
    if UI.StatusBar.Control {
        DllCall("MoveWindow"
            , "Ptr", UI.StatusBar.Control
            , "Int", 0
            , "Int", UI.Main.Height - 25
            , "Int", UI.Main.Width
            , "Int", 25
            , "Int", true
        )
    }
}
```

### 页面注册系统

**UI_RegisterAllPages()**
```autohotkey
; 注册所有页面
UI_RegisterAllPages() {
    ; 角色配置页面
    UI_RegisterPage("page_profile", {
        Name: "角色配置",
        FilePath: "modules\ui\pages\Page_Profile.ahk",
        OnEnter: "Page_Profile_OnEnter",
        Build: "Page_Profile_Build"
    })
    
    ; 技能管理页面
    UI_RegisterPage("page_skills", {
        Name: "技能管理", 
        FilePath: "modules\ui\pages\Page_Skills.ahk",
        OnEnter: "Page_Skills_OnEnter",
        Build: "Page_Skills_Build"
    })
    
    ; 规则配置页面
    UI_RegisterPage("page_rules", {
        Name: "规则配置",
        FilePath: "modules\ui\pages\Page_Rules.ahk",
        OnEnter: "Page_Rules_OnEnter",
        Build: "Page_Rules_Build"
    })
    
    ; BUFF管理页面
    UI_RegisterPage("page_buffs", {
        Name: "BUFF管理",
        FilePath: "modules\ui\pages\Page_Buffs.ahk",
        OnEnter: "Page_Buffs_OnEnter", 
        Build: "Page_Buffs_Build"
    })
    
    ; 线程管理页面
    UI_RegisterPage("page_threads", {
        Name: "线程管理",
        FilePath: "modules\ui\pages\Page_Threads.ahk",
        OnEnter: "Page_Threads_OnEnter",
        Build: "Page_Threads_Build"
    })
    
    ; 轮换配置页面
    UI_RegisterPage("page_rotation", {
        Name: "轮换配置",
        FilePath: "modules\ui\pages\rotation\Page_Rotation.ahk",
        OnEnter: "Page_Rotation_OnEnter",
        Build: "Page_Rotation_Build"
    })
    
    ; 快速工具页面
    UI_RegisterPage("tools_quick", {
        Name: "快速工具",
        FilePath: "modules\ui\pages\tools\Page_Tools_Quick.ahk",
        OnEnter: "Page_Tools_Quick_OnEnter",
        Build: "Page_Tools_Quick_Build"
    })
    
    ; IO工具页面
    UI_RegisterPage("tools_io", {
        Name: "IO工具",
        FilePath: "modules\ui\pages\tools\Page_Tools_IO.ahk", 
        OnEnter: "Page_Tools_IO_OnEnter",
        Build: "Page_Tools_IO_Build"
    })
    
    ; 关于页面
    UI_RegisterPage("settings_about", {
        Name: "关于",
        FilePath: "modules\ui\pages\settings\Page_Settings_About.ahk",
        Build: "Page_Settings_About_Build"
    })
    
    ; 语言设置页面
    UI_RegisterPage("settings_language", {
        Name: "语言设置",
        FilePath: "modules\ui\pages\settings\Page_Settings_Language.ahk",
        Build: "Page_Settings_Language_Build"
    })
    
    UI_Log("所有页面注册完成")
}
```

## 4. 功能页面模块

### 页面文件结构

所有功能页面位于 `modules\ui\pages/` 目录下，按功能分类：

```
pages/
├── _index.ahk          # 页面索引文件
├── Page_Profile.ahk    # 角色配置页面
├── Page_Skills.ahk     # 技能管理页面  
├── Page_Rules.ahk      # 规则配置页面
├── Page_Buffs.ahk      # Buff管理页面
├── Page_Threads.ahk    # 线程管理页面
├── automation/         # 自动化相关页面
│   ├── Page_Rules_Summary.ahk
│   └── Page_Buffs_Summary.ahk
├── rotation/           # 轮换配置页面
│   ├── Page_Rotation.ahk
│   └── Page_Tracks.ahk
├── tools/              # 工具页面
│   ├── Page_Tools_Quick.ahk
│   └── Page_Tools_IO.ahk
└── settings/           # 设置页面
    ├── Page_Settings_About.ahk
    └── Page_Settings_Language.ahk
```

### 页面开发规范

**标准页面结构**:
```autohotkey
; 页面进入事件
Page_[Name]_OnEnter() {
    global UI
    
    ; 页面进入时的初始化
    UI_UpdateStatusBar("进入" [页面名称] "页面")
    
    ; 恢复页面状态
    ; 加载数据
    ; 设置默认选项
}

; 页面构建函数
Page_[Name]_Build(contentArea) {
    global UI
    
    try {
        ; 创建页面内容
        ; 添加控件
        ; 设置布局
        ; 绑定事件
        
        return true
    } catch error {
        UI_Log("页面构建失败: " error.message)
        return false
    }
}

; 页面布局函数
Page_[Name]_Layout() {
    global UI
    
    ; 窗口大小改变时的布局调整
    ; 重新计算控件位置
    ; 更新控件大小
}
```

## 5. UI事件系统

### 事件类型

**窗口事件**:
- 窗口创建/销毁
- 大小调整
- 最小化/最大化
- 获得/失去焦点

**控件事件**:
- 按钮点击
- 选择变更
- 文本变更
- 键盘输入

**页面事件**:
- 页面切换
- 数据加载
- 状态保存
- 验证检查

### 事件处理机制

**事件路由**:
```autohotkey
; 统一事件处理
UI_HandleEvent(eventType, source, data) {
    global UI
    
    switch eventType {
        case "WindowResize":
            UI_OnWindowResize(data)
        case "PageChange":
            UI_OnPageChange(data)
        case "DataChange":
            UI_OnDataChange(data)
        case "Error":
            UI_OnError(data)
    }
}
```

## 6. 性能优化

### 渲染优化

**策略**:
- **延迟加载**: 页面内容按需加载
- **缓存机制**: 页面状态和数据缓存
- **批量更新**: 控件批量更新减少重绘
- **最小重绘**: 只重绘变更的控件区域

### 内存管理

**管理方式**:
- **及时释放**: 页面切换时释放不需要的资源
- **对象池**: 复用临时控件对象
- **弱引用**: 使用弱引用避免循环引用
- **垃圾回收**: 主动触发垃圾回收

### 用户体验优化

**优化措施**:
- **进度指示**: 长时间操作的进度显示
- **状态反馈**: 实时操作状态反馈
- **快捷键**: 支持键盘快捷键操作
- **拖拽支持**: 支持拖拽操作

## 7. 样式和主题

### 主题系统

**主题配置**:
```autohotkey
; 主题定义
UI_Themes := {
    Default: {
        Colors: {
            Background: 0xFFFFFF,
            Border: 0xC0C0C0,
            Text: 0x000000,
            Selected: 0xE0E0E0
        },
        Fonts: {
            Default: "微软雅黑 9",
            Title: "微软雅黑 12 Bold",
            Small: "微软雅黑 8"
        }
    },
    Dark: {
        Colors: {
            Background: 0x2D2D2D,
            Border: 0x555555,
            Text: 0xFFFFFF,
            Selected: 0x404040
        }
    }
}
```

### 控件样式

**统一样式**:
```autohotkey
; 应用统一样式
UI_ApplyStyles() {
    ; 设置全局字体
    ; 设置颜色方案
    ; 配置边框样式
    ; 调整控件间距
}
```

## 总结

UI框架系统提供了完整的用户界面解决方案，通过模块化设计实现了清晰的职责分离和高度的可扩展性。框架支持多种功能页面的动态管理，提供了完善的布局辅助工具和事件处理机制。

**核心优势**:
- ✅ 模块化架构，功能清晰分离
- ✅ 完善的页面管理和生命周期控制
- ✅ DPI感知的布局系统
- ✅ 灵活的页面注册和切换机制
- ✅ 强大的事件处理和状态管理
- ✅ 优秀的用户体验和性能表现

**应用价值**:
- 为复杂桌面应用提供可靠的UI基础
- 支持快速开发和维护多个功能模块
- 提供一致的用户体验和界面风格
- 为未来功能扩展提供良好的架构基础

**扩展建议**:
- 添加更多主题支持
- 增加动画效果和过渡
- 支持更复杂的布局需求
- 集成更多第三方UI组件