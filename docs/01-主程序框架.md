# 主程序框架 - Main.ahk 详细文档

## 概述

主程序文件 `Main.ahk` 是整个Game Macro的核心入口，负责系统的初始化、模块加载、权限检查和整体协调。它是整个应用程序的生命周期管理器。

## 核心职责

### 1. 系统初始化管理
- **权限检查**: 自动检测并请求管理员权限
- **单实例控制**: 确保系统中只有一个实例运行
- **工作目录设置**: 配置程序运行的基础目录
- **坐标模式配置**: 设置全局坐标系统模式

### 2. 模块加载系统
通过 `#Include` 指令动态加载所有功能模块：

```autohotkey
; 工具模块
#Include modules\util\Utils.ahk

; 国际化模块  
#Include modules\i18n\Lang.ahk

; 核心模块
#Include modules\core\Core.ahk
#Include modules\core\AppConfig.ahk

; 存储模块
#Include modules\storage\Storage.ahk
#Include modules\storage\Exporter.ahk

; 引擎模块
#Include modules\engines\Dup.ahk
#Include modules\engines\Pixel.ahk
#Include modules\engines\Poller.ahk
#Include modules\engines\Rotation.ahk
#Include modules\engines\RuleEngine.ahk
#Include modules\engines\BuffEngine.ahk

; 运行时组件
#Include modules\runtime\Counters.ahk
#Include modules\runtime\Hotkeys.ahk

; UI框架
#Include modules\ui\UI_Framework.ahk
#Include modules\ui\UI_Layout.ahk
#Include modules\ui\UI_Shell.ahk

; UI页面
#Include modules\ui\pages\_index.ahk

; 工作池
#Include modules\workers\WorkerPool.ahk
#Include modules\workers\WorkerHost.ahk
```

### 3. 应用程序初始化序列

主程序定义了严格的初始化顺序，确保各模块按依赖关系正确启动：

```autohotkey
; 初始化序列
AppConfig_Init()    ; 应用配置初始化
Lang_Init()         ; 语言系统初始化  
Core_Init()         ; 核心功能初始化
Dup_InitAuto()      ; 屏幕复制引擎初始化
```

### 4. 全局状态管理

系统使用全局Map对象 `App` 存储所有核心状态：

```autohotkey
global App := Map()
global UI := Map()
global Poller := Map()
global Lang := Map()
```

## 功能模块详解

### 权限管理

**功能特点**:
- 自动检测管理员权限
- 请求管理员权限提升
- 权限验证和错误处理

**实现逻辑**:
```autohotkey
; 检查是否以管理员权限运行
if (!A_IsAdmin) {
    ; 请求管理员权限
    Run "*RunAs " A_ScriptFullPath
    ExitApp()
}
```

### 单实例控制

**功能特点**:
- 检测已有实例运行
- 自动关闭重复实例
- 进程间通信机制

**实现逻辑**:
```autohotkey
#SingleInstance Force    ; 强制单实例
```

### 托盘图标管理

**功能特点**:
- 系统托盘图标显示
- 右键菜单功能
- 双击快捷操作
- 图标状态显示

**托盘菜单**:
```autohotkey
Menu, Tray, NoStandard
Menu, Tray, Add
Menu, Tray, Add, 显示主界面, ShowMain
Menu, Tray, Add
Menu, Tray, Add, 开始运行, StartMacro
Menu, Tray, Add, 停止运行, StopMacro  
Menu, Tray, Add
Menu, Tray, Add, 退出, ExitApp
```

## 全局配置设置

### 坐标模式

**设置项目**:
- **CoordMode**: 设置坐标模式（Screen/Window/Client）
- **Mouse**: 鼠标相关配置
- **Pixel**: 像素检测相关配置
- **ToolTip**: 提示框相关配置

```autohotkey
CoordMode "Mouse", "Screen"
CoordMode "Pixel", "Screen" 
CoordMode "ToolTip", "Screen"
```

### 性能优化设置

**关键参数**:
- **SetBatchLines**: 批处理行数设置
- **SetKeyDelay**: 按键延迟设置
- **SetDefaultMouseSpeed**: 默认鼠标速度

```autohotkey
SetBatchLines -1
SetKeyDelay 0, 50
SetDefaultMouseSpeed 0
```

## 生命周期管理

### 启动流程

1. **权限检查** → 确保管理员权限
2. **单实例验证** → 防止重复运行  
3. **工作目录设置** → 配置基础路径
4. **模块加载** → 动态加载所有功能模块
5. **初始化序列** → 按序初始化各子系统
6. **主界面显示** → 启动用户界面

### 退出流程

**清理函数**:
```autohotkey
OnExit("App_Exit_Cleanup")

App_Exit_Cleanup(exitReason, exitCode) {
    try Poller_Stop()
    try WorkerPool_Dispose()
    try UI_Exit_Cleanup()
    try Dup_Shutdown()
}
```

**清理内容**:
- 停止轮询引擎
- 释放工作池资源
- 清理UI组件
- 关闭屏幕捕获
- 保存配置数据

## 错误处理机制

### 异常捕获

**处理范围**:
- 模块加载失败
- 初始化异常
- 运行时错误
- 资源释放失败

**处理策略**:
- 详细错误日志记录
- 用户友好的错误提示
- 优雅的降级处理
- 强制清理机制

### 日志系统

**日志等级**:
- **INFO**: 一般信息
- **WARNING**: 警告信息  
- **ERROR**: 错误信息
- **FATAL**: 致命错误

**输出目标**:
- 控制台输出
- 文件日志
- 托盘提示
- 错误对话框

## 配置管理

### 全局变量

**核心对象**:
```autohotkey
global App := {
    Version: "1.1.0",
    Title: "Game Macro", 
    Author: "Game Macro Team",
    IsRunning: false,
    ProfileData: Map(),
    BoundHotkeys: Map()
}
```

**状态标志**:
- `App.IsRunning`: 运行状态标志
- `App.ProfileData`: 当前配置文件数据
- `App.BoundHotkeys`: 已绑定热键映射

### 路径管理

**关键路径**:
```autohotkey
ScriptDir := A_ScriptDir
ConfigDir := ScriptDir "\Config"
ProfileDir := ScriptDir "\Profiles" 
ExportDir := ScriptDir "\Exports"
LogDir := ScriptDir "\Logs"
```

## 扩展性设计

### 模块化架构

**设计原则**:
- **松耦合**: 模块间依赖最小化
- **高内聚**: 模块内部功能紧密相关
- **可插拔**: 支持动态加载和卸载
- **版本兼容**: 模块版本独立管理

### 事件驱动

**事件类型**:
- 初始化完成事件
- 配置变更事件
- 状态切换事件
- 错误发生事件

**事件处理**:
```autohotkey
; 事件注册
Event_Register("InitComplete", "OnInitComplete")
Event_Register("ConfigChanged", "OnConfigChanged")
Event_Register("StateChanged", "OnStateChanged")
```

## 性能考虑

### 启动优化

**优化策略**:
- 延迟加载非关键模块
- 异步初始化耗时操作
- 缓存初始化结果
- 预编译常用资源

### 内存管理

**管理机制**:
- Map对象的高效使用
- 及时清理临时数据
- 避免内存泄漏
- 合理的对象生命周期

## 安全性考虑

### 权限管理

**安全措施**:
- 最小权限原则
- 权限验证检查
- 安全的文件访问
- 防止权限提升攻击

### 数据保护

**保护机制**:
- 配置数据加密存储
- 敏感信息脱敏
- 安全的进程间通信
- 防止数据篡改

## 调试支持

### 调试模式

**调试功能**:
- 详细日志输出
- 性能监控
- 内存使用统计
- 错误追踪

### 诊断工具

**工具集成**:
- 模块加载状态检查
- 初始化流程追踪
- 运行时状态监控
- 资源使用分析

## 总结

主程序框架作为整个Game Macro的核心，承担着系统初始化、模块协调、生命周期管理等关键职责。其设计充分体现了模块化、事件驱动、性能优先的设计理念，为整个应用提供了稳定可靠的基础架构。

**核心优势**:
- ✅ 严格的初始化序列保证系统稳定性
- ✅ 完善的错误处理机制提高可靠性
- ✅ 模块化设计支持灵活扩展
- ✅ 丰富的生命周期管理功能
- ✅ 强大的调试和诊断支持

**适用场景**:
- 多模块应用的统一管理
- 需要高可靠性的系统框架
- 复杂的初始化流程控制
- 大型AutoHotkey项目的架构基础