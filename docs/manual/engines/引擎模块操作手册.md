# 引擎模块操作手册

## 概述

引擎模块是游戏宏程序的核心"执行器"，负责处理颜色识别、技能发射、BUFF管理、规则执行和旋转切换等关键功能。理解这些引擎能够帮助您更好地配置和使用自动化宏。

## 引擎模块组成

### 1. 颜色识别引擎 (Pixel Engine)

#### 功能作用
颜色识别引擎负责检测游戏界面中特定位置的颜色变化，是识别技能状态的基础。

#### 主要特性
- **帧级缓存**: 一次帧内重复取色时使用缓存，提高效率
- **多层级取色**: 优先使用DXGI高速取色，失败时回退到ROI缓存，最后使用系统GDI取色
- **颜色容差**: 支持设置颜色匹配容差，应对光线变化
- **自动ROI**: 自动计算技能区域，优化取色性能

#### 用户使用方法

**第一步：设置技能坐标**
1. 在游戏界面中找到技能图标位置
2. 记录X、Y坐标值（屏幕像素坐标）
3. 确保游戏窗口大小固定，布局一致

**第二步：配置技能颜色**
```
技能配置示例：
技能名称: 火球术
按键: Q
X坐标: 100
Y坐标: 200  
颜色: 0xFF5733 (橙红色)
容差: 15 (允许15点的颜色偏差)
```

**第三步：调整颜色容差**
- **低容差(5-10)**: 颜色要求严格，适合光线稳定的室内环境
- **中等容差(10-20)**: 平衡设置，适合大多数游戏场景  
- **高容差(20-30)**: 颜色要求宽松，适合光线变化较大的环境

#### 高级设置

**ROI自动区域设置**
系统会自动计算所有技能的包围盒，只在这个区域内进行取色，大幅提高性能。

**多显示器支持**
支持多显示器环境，可以指定在哪个显示器上进行取色操作。

### 2. BUFF管理引擎 (Buff Engine)

#### 功能作用
BUFF管理引擎负责自动维持角色身上的增益效果，确保重要BUFF不会过期。

#### 主要特性
- **优先释放**: BUFF续期优先级高于其他技能
- **多技能轮转**: 在多个BUFF技能之间智能轮转
- **精确计时**: 基于毫秒级的精确计时控制
- **线程隔离**: 不同BUFF组可以在不同线程执行

#### 配置方法

**添加BUFF监控**
```
BUFF配置示例：
BUFF名称: 法力护盾
持续时间: 30000毫秒 (30秒)
提前刷新: 5000毫秒 (到期前5秒开始刷新)
检查就绪: 是 (必须技能图标亮起才使用)
线程ID: 1 (在第1线程执行)
关联技能: [1, 2, 3] (技能索引1、2、3都可以刷新此BUFF)
```

**BUFF配置步骤**
1. **确定BUFF持续时间**
   - 在游戏中查看BUFF说明，记住持续时间
   - 建议实际测试，因为实际持续时间可能与显示不同

2. **设置提前刷新时间**
   - 避免BUFF刚好到期才开始刷新
   - 建议设置为2-5秒提前量

3. **选择相关技能**
   - 选择所有能够刷新该BUFF的技能
   - 系统会在这些技能之间智能轮转

4. **设置线程分配**
   - 重要BUFF分配到独立线程
   - 普通BUFF可以共用线程

#### 使用技巧

**多BUFF优化**
- 将同时到期的BUFF分配到同一线程
- 将不同时间段的BUFF分配到不同线程
- 重要BUFF设置更短的提前刷新时间

**技能轮转策略**
- 优先使用冷却时间短的技能
- 根据技能消耗合理轮转
- 避免连续使用相同技能

### 3. 旋转引擎 (Rotation Engine)

#### 功能作用
旋转引擎负责在多个技能轨道之间自动切换，实现复杂的技能循环。

#### 主要特性
- **多轨道管理**: 支持最多99个不同的技能轨道
- **智能切换**: 基于游戏状态自动选择合适的轨道
- **防卡死机制**: 防止在某个轨道上卡死
- **保护系统**: 包含黑屏保护、施法锁保护等

#### 轨道配置

**创建新轨道**
```
轨道配置示例：
轨道1: 日常输出循环
- 技能顺序: [1, 2, 3, 4, 5]
- 触发条件: 普通怪物
- 优先级: 1

轨道2: 爆发输出循环  
- 技能顺序: [2, 1, 6, 7, 3]
- 触发条件: Boss战斗
- 优先级: 2
```

**切换策略设置**
- **自动切换**: 基于游戏状态自动选择轨道
- **手动切换**: 通过按键手动切换轨道
- **混合模式**: 结合自动和手动控制

#### 黑屏保护

**功能说明**
黑屏保护用于检测游戏黑屏或卡顿情况，自动暂停或切换轨道。

**配置参数**
```
黑屏保护设置：
启用: 是
采样次数: 5 (连续检测5次)
黑屏比例阈值: 0.7 (70%以上像素为黑色)
检测窗口: 120毫秒
保护冷却: 600毫秒
```

### 4. 屏幕捕获引擎 (DXGI Dup Engine)

#### 功能作用
屏幕捕获引擎提供高性能的屏幕内容捕获，是实现精确取色的关键技术。

#### 主要特性
- **高性能**: 相比传统GDI取色性能提升10倍以上
- **低延迟**: 毫秒级响应速度
- **多显示器**: 支持多显示器环境
- **自动降级**: 取色失败时自动回退到备用方案

#### 配置方法

**选择显示器输出**
```
显示器设置：
输出索引: 0 (主显示器)
刷新率: 60Hz
禁用DXGI: 否 (如果遇到问题可以关闭)
```

**性能调优**
- **帧率设置**: 根据游戏需求调整屏幕捕获帧率
- **缓冲大小**: 根据内存情况调整缓冲区大小
- **调试模式**: 开发阶段可以开启调试日志

#### 故障排除

**常见问题**
1. **DXGI初始化失败**
   - 检查是否以管理员权限运行
   - 确认显卡驱动是最新的
   - 尝试禁用DXGI功能

2. **取色不准确**
   - 检查显示器颜色设置
   - 确认游戏窗口没有被拉伸
   - 尝试调整颜色容差

3. **性能问题**
   - 降低屏幕捕获帧率
   - 开启ROI自动区域
   - 减少取色点数量

### 5. 规则引擎 (Rule Engine)

#### 功能作用
规则引擎负责根据复杂的条件判断来执行相应的动作，是实现智能自动化的大脑。

#### 主要特性
- **多条件判断**: 支持复杂的条件组合
- **动作序列**: 可以执行一连串动作
- **状态管理**: 维护规则执行状态
- **日志记录**: 详细的规则执行日志

#### 规则配置

**条件设置**
```
条件示例：
条件1: 血量 < 30%
条件2: 蓝量 > 50% 
条件3: 距离敌人 < 10米
条件组合: 条件1 AND 条件2 OR 条件3
```

**动作设置**
```
动作示例：
动作1: 使用治疗技能1 (按键: F1)
动作2: 使用治疗技能2 (按键: F2)  
动作3: 切换到防御轨道
动作4: 发送消息: "血量过低，使用治疗"
```

**完整规则配置**
```
规则名称: 紧急治疗
启用状态: 开启
优先级: 10 (数字越大优先级越高)
触发条件: 血量百分比 < 25%
执行动作: [治疗技能1, 治疗技能2, 切换防御轨道]
```

#### 高级用法

**条件运算符**
- **AND**: 所有条件都为真
- **OR**: 任一条件为真  
- **NOT**: 条件取反
- **括号**: 控制条件优先级

**动作类型**
- **按键动作**: 发送指定按键
- **延迟动作**: 等待指定时间
- **循环动作**: 重复执行某动作
- **条件动作**: 基于子条件执行

## 引擎协同工作

### 工作流程

1. **屏幕捕获** (DXGI Dup Engine)
   - 高频率捕获游戏画面
   - 提供实时像素数据

2. **颜色识别** (Pixel Engine) 
   - 从捕获的画面中提取指定位置颜色
   - 与预设颜色进行匹配判断

3. **规则判断** (Rule Engine)
   - 基于颜色识别结果判断条件
   - 决定是否触发相应动作

4. **技能执行** (Buff Engine + Worker Pool)
   - 执行具体的按键操作
   - 管理BUFF状态和技能冷却

5. **轨道切换** (Rotation Engine)
   - 根据当前状况选择合适的技能轨道
   - 实现复杂的循环逻辑

### 性能优化建议

#### 系统级优化
- **关闭不必要的后台程序**: 释放CPU和内存资源
- **确保管理员权限**: 部分功能需要管理员权限才能正常工作
- **稳定的游戏环境**: 避免游戏窗口大小变化和位置移动

#### 配置级优化
- **合理的轮询间隔**: 25-50毫秒通常能满足大多数需求
- **精准的ROI区域**: 只在技能区域进行取色
- **适度的颜色容差**: 避免过于严格或宽松的颜色匹配

#### 硬件级优化
- **充足内存**: 确保系统有足够的可用内存
- **稳定显卡驱动**: 更新到最新版本的显卡驱动
- **合理显示器设置**: 避免颜色校准导致的识别偏差

## 故障排除

### 常见问题诊断

**问题1: 技能不识别**
1. 检查技能坐标是否准确
2. 确认颜色设置正确
3. 调整颜色容差
4. 检查游戏窗口是否被遮挡

**问题2: BUFF管理不准确**
1. 核实BUFF持续时间
2. 检查提前刷新设置
3. 确认相关技能索引正确
4. 调整线程分配

**问题3: 旋转轨道切换异常**
1. 检查触发条件设置
2. 确认轨道优先级配置
3. 检查黑屏保护设置
4. 查看规则引擎日志

**问题4: 性能问题**
1. 降低屏幕捕获帧率
2. 减少同时监控的技能数量
3. 开启ROI自动优化
4. 关闭不必要的引擎功能

### 日志分析

**重要日志文件**
- `Logs/dxgi_dup.log`: 屏幕捕获引擎日志
- `Logs/buff_engine.log`: BUFF管理引擎日志
- `Logs/rotation_engine.log`: 旋转引擎日志
- `Logs/rule_engine.log`: 规则引擎日志

**日志级别说明**
- **INFO**: 正常运行信息
- **WARN**: 警告信息，可能影响性能但不影响功能
- **ERROR**: 错误信息，影响正常功能
- **DEBUG**: 调试信息，仅在开发阶段使用

## 最佳实践

### 配置建议

1. **循序渐进**: 先配置基本的技能识别，再添加高级功能
2. **充分测试**: 在安全环境中充分测试配置
3. **备份配置**: 定期备份工作正常的配置文件
4. **性能监控**: 关注CPU和内存使用情况

### 安全使用

1. **遵守规则**: 始终遵守游戏的服务条款
2. **适度使用**: 避免过度自动化导致被检测
3. **及时停止**: 遇到问题立即停止运行
4. **定期检查**: 定期更新配置以适应游戏变化

## 高级功能

### 自定义取色区域
- 可以自定义任意形状的取色区域
- 支持多区域同时监控
- 区域间可以设置优先级

### 智能预测
- 基于历史数据预测游戏状态
- 提前执行某些动作
- 减少反应延迟

### 宏脚本集成
- 可以导入外部宏脚本
- 支持自定义动作序列
- 与游戏API集成

---

**注意**: 引擎模块功能强大但需要谨慎配置，建议在充分理解每个功能后再进行复杂配置。