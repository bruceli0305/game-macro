# 工作池模块操作手册

## 概述

工作池模块是游戏宏系统中负责按键发送的核心组件，它采用多进程架构和线程安全管理，确保技能按键能够稳定、准确地发送到游戏客户端。该模块通过外部进程处理按键发送，避免了对主程序的干扰，提高了系统的稳定性和响应速度。

## 主要功能

### 1. 进程池管理
- **外部进程处理**: 将按键发送任务交给独立的外部进程执行
- **进程复用**: 智能查找和复用现有的WorkerHost进程
- **进程监控**: 监控外部进程状态，确保稳定运行

### 2. 线程安全控制
- **施法锁定机制**: 防止同一线程内的技能冲突
- **线程隔离**: 不同线程间的技能发送相互独立
- **冷却时间管理**: 自动管理技能的施法冷却时间

### 3. 按键发送管理
- **Fire-and-Forget模式**: 异步发送按键，不阻塞主程序
- **按住键支持**: 支持需要长按的按键操作
- **延迟发送**: 可配置按键发送的延迟时间
- **按键验证**: 自动验证按键的有效性

### 4. 性能监控
- **技能计数器**: 统计每个技能的使用次数
- **日志记录**: 详细的发送日志便于调试和优化
- **性能统计**: 监控发送成功率和响应时间

## 核心组件

### WorkerPool（工作池管理器）
- **职责**: 管理整个按键发送系统的工作流程
- **功能**: 进程调度、线程控制、性能监控
- **位置**: `modules\workers\WorkerPool.ahk`

### WorkerHost（工作宿主）
- **职责**: 实际执行按键发送的外部进程
- **功能**: 按键发送、按住控制、进程间通信
- **位置**: `modules\workers\WorkerHost.ahk`

## 工作原理

### 1. 进程查找与启动
```
主程序 → 查找WorkerHost → 启动外部进程 → 建立通信
```

### 2. 按键发送流程
```
技能触发 → 检查线程锁 → 构建发送参数 → 启动外部发送 → 更新计数器
```

### 3. 线程安全管理
```
线程ID → 检查锁定状态 → 设置冷却时间 → 发送按键 → 记录日志
```

## 操作指南

### 1. 基本配置
**WorkerHost路径自动检测**:
程序会自动按以下顺序查找WorkerHost：
1. 程序配置的WorkerHostPath
2. 环境变量WORKERHOST_PATH
3. 程序目录下的WorkerHost.exe
4. 程序目录下的WorkerHost.ahk

**建议配置**:
- 优先使用WorkerHost.exe（更稳定）
- 确保WorkerHost文件在正确位置
- 检查文件的执行权限

### 2. 性能优化设置

#### 冷却时间配置
```ini
[General]
SendCooldownMs=80          ; 基础冷却时间(毫秒)
DefaultHoldMs=0            ; 默认按住时间(毫秒)
```

#### 技能级配置
```ini
[Skill1]
Name=普通攻击
Key=1
CastMs=500                 ; 施法时间(毫秒)
HoldMs=0                   ; 单独按住时间(毫秒)
```

### 3. 高级功能使用

#### 多线程配置
```ini
[Thread1]
Name=主输出线程

[Thread2]
Name=辅助技能线程
```

#### 强制按住覆盖
通过holdOverride参数可以临时覆盖技能的按住设置：
```ahk
; 使用自定义按住时间
WorkerPool_SendSkillIndex(1, 3, "Rule:血量治疗", 500)
```

## 故障排除

### WorkerHost启动失败
**症状**: 按键无法发送，日志显示"WorkerHost not found"
**解决方法**:
1. 检查WorkerHost.exe是否存在
2. 验证文件路径是否正确
3. 确认文件有执行权限
4. 查看Windows防病毒软件是否阻止

### 按键发送延迟
**症状**: 技能执行有明显延迟
**解决方法**:
1. 调整SendCooldownMs参数
2. 检查WorkerHost进程数量
3. 优化冷却时间设置
4. 检查系统负载情况

### 技能冲突
**症状**: 多个技能同时触发导致失效
**解决方法**:
1. 检查线程分配是否合理
2. 调整CastMs施法时间
3. 启用施法锁定机制
4. 优化技能优先级设置

### 进程异常退出
**症状**: WorkerHost进程频繁重启或退出
**解决方法**:
1. 检查系统资源使用情况
2. 验证游戏客户端稳定性
3. 查看错误日志文件
4. 调整进程启动参数

### 性能问题
**症状**: CPU占用率高或内存泄漏
**解决方法**:
1. 检查WorkerHost进程数量
2. 优化冷却时间间隔
3. 清理日志文件
4. 重启WorkerHost进程

## 最佳实践

### 1. 性能优化
```
推荐配置：
- SendCooldownMs: 60-100ms
- CastMs: 技能实际施法时间
- ThreadCount: 根据CPU核心数设置

避免配置：
- 过短的冷却时间（<50ms）
- 过长的按住时间（>2000ms）
- 过多的并发线程
```

### 2. 稳定性建议
```
进程管理：
- 优先使用.exe版本的WorkerHost
- 定期清理日志文件
- 监控系统资源使用

线程管理：
- 按技能类型分配线程
- 避免同一线程内技能冲突
- 合理设置冷却时间
```

### 3. 调试技巧
```
日志分析：
- 关注发送成功率和失败原因
- 监控技能计数器的准确性
- 检查线程锁的触发频率

性能监控：
- 观察WorkerHost进程数量
- 监控按键发送的响应时间
- 定期分析性能瓶颈
```

## 与其他模块的协作

### 与运行时模块协作
- 接收轮询系统的技能触发指令
- 为热键系统提供按键发送服务
- 支持多线程并发执行

### 与引擎模块协作
- 为颜色识别引擎提供按键反馈
- 支持BUFF引擎的技能触发
- 与旋转引擎协调技能时序

### 与存储模块协作
- 从配置文件中读取技能参数
- 保存技能使用统计信息
- 支持多种线程配置方案

## 注意事项

1. **进程权限**: 确保WorkerHost进程有足够的系统权限
2. **防病毒软件**: 可能需要将WorkerHost添加到白名单
3. **系统资源**: 监控内存和CPU使用情况
4. **日志管理**: 定期清理WorkerHost日志文件
5. **版本兼容**: 确保WorkerHost版本与主程序兼容

通过正确配置和使用工作池模块，可以实现高效、稳定的多线程按键发送，显著提升游戏宏的自动化性能和可靠性。