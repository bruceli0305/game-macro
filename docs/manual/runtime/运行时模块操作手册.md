# 运行时模块操作手册

## 概述

运行时模块是游戏宏程序的"调度中心"，负责管理热键绑定、轮询执行、计数器统计等核心运行时功能。理解这些组件能帮助您更好地控制宏的运行行为。

## 模块组成

### 1. 热键管理 (Hotkeys)

#### 功能作用
热键管理系统负责绑定和控制宏的开始/停止热键，让您可以通过按键快速控制宏的运行状态。

#### 主要特性
- **灵活绑定**: 支持键盘和鼠标按键
- **智能处理**: 自动为鼠标按键添加穿透前缀
- **动态切换**: 支持运行时的热键更换
- **状态同步**: 热键状态与程序运行状态实时同步

#### 热键配置

**支持的热键类型**
```
键盘按键: F1-F12, 数字键1-0, 字母键A-Z
功能键: Space, Enter, Tab, Esc
修饰键: Ctrl+, Alt+, Shift+
组合键: Ctrl+F1, Alt+F2, Shift+F9
鼠标按键: LButton, RButton, MButton, XButton1, XButton2
```

**默认配置**
- **开始/停止键**: F9
- **功能说明**: 按一次开始，再次按停止

#### 使用方法

**第一步：设置热键**
1. 进入宏配置界面
2. 找到"基础设置"部分
3. 在"开始热键"字段输入您想要的热键

**第二步：测试热键**
1. 保存配置
2. 按下设置的热键
3. 观察状态提示（运行中/已停止）

**第三步：优化热键选择**
```
推荐热键：
F9-F12: 容易记忆，不易误触
数字键1-0: 快速访问，适合熟练用户
鼠标按键: 一键操作，适合简单场景
避免使用：
Ctrl+字母: 可能与游戏快捷键冲突
Esc: 通常用于退出游戏
Space: 容易意外触发
```

#### 高级技巧

**热键冲突处理**
如果热键与其他程序冲突：
1. 更换为不冲突的热键
2. 关闭冲突程序
3. 使用修饰键组合（如Ctrl+F9）

**多热键支持**
```
常用多热键设置：
主热键: F9 (开始/停止)
备用热键: F10 (仅停止)
紧急停止: ~XButton2 (鼠标中键，强制停止)
```

### 2. 轮询系统 (Poller)

#### 功能作用
轮询系统是宏程序的"心脏"，负责按照设定的时间间隔检查游戏状态，并执行相应的动作。

#### 工作原理
```
轮询流程：
1. 捕获游戏画面
2. 检测技能状态
3. 执行BUFF管理
4. 处理规则逻辑
5. 发送技能按键
```

#### 轮询配置

**轮询间隔设置**
```
快速模式: 15-25ms
- 优点: 反应迅速，技能衔接流畅
- 缺点: CPU占用较高
- 适用: 竞技类、动作类游戏

平衡模式: 25-50ms  
- 优点: 性能与响应平衡
- 缺点: 中等性能消耗
- 适用: 大多数RPG、策略游戏

节能模式: 50-100ms
- 优点: CPU占用低
- 缺点: 反应稍慢
- 适用: 挂机、自动化任务
```

**屏幕捕获检测**
系统会自动检测屏幕捕获环境：
- **窗口化模式**: 最佳兼容性，推荐使用
- **全屏窗口化**: 需要调整设置
- **独占全屏**: 可能无法正常工作

#### 兜底技能机制

**什么是兜底技能？**
兜底技能是当所有其他技能都无法使用时，自动执行的基础技能，确保宏始终有动作。

**兜底技能配置**
```
兜底技能设置示例：
启用兜底技能: 是
选择技能: 火球术 (技能索引3)
检测就绪: 是 (技能图标必须亮起)
执行线程: 1
冷却时间: 600ms (防止连续发送)
预延时: 0ms (立即执行)
```

**兜底技能原理**
```
执行逻辑：
1. BUFF引擎检查 → 无可用技能
2. 规则引擎检查 → 无触发条件  
3. 旋转引擎检查 → 无合适轨道
4. 执行兜底技能 → 发送基础技能
5. 重置计时器 → 等待冷却结束
```

#### 会话优先机制

**会话系统作用**
会话系统允许在特殊情况下（如剧情对话、商店界面）暂停自动化，优先处理用户交互。

**会话检测逻辑**
```
检测条件：
- 游戏窗口失去焦点
- 出现对话框界面
- 检测到特定UI元素
- 手动触发会话模式

处理方式：
- 暂停所有自动化逻辑
- 显示会话状态提示
- 等待用户完成交互
- 自动恢复自动化
```

### 3. 计数器系统 (Counters)

#### 功能作用
计数器系统用于统计各种事件的发生次数，为优化配置和监控性能提供数据支持。

#### 主要用途

**技能使用统计**
```
应用场景：
- 统计各技能使用频率
- 分析技能冷却时间
- 优化技能配置
- 监控宏运行效率
```

**BUFF管理统计**
```
统计内容：
- BUFF刷新次数
- BUFF遗漏次数
- 技能轮转次数
- 规则触发次数
```

**性能监控**
```
监控指标：
- 每分钟执行次数
- CPU使用时间
- 内存使用量
- 错误发生次数
```

#### 使用方法

**查看统计信息**
1. 在宏界面中找到"统计信息"选项
2. 查看各类计数器的数值
3. 分析统计数据进行调整

**重置计数器**
```
重置时机：
- 更换游戏配置
- 开始新的测试
- 清理历史数据
- 故障排除后

重置方法：
- 手动重置：点击重置按钮
- 自动重置：程序启动时自动清零
- 条件重置：满足特定条件时重置
```

## 协同工作机制

### 运行时流程

**启动流程**
```
1. 热键绑定
   ↓
2. 轮询系统初始化
   ↓  
3. 屏幕捕获检测
   ↓
4. 计数器清零
   ↓
5. 开始轮询循环
   ↓
6. 状态提示"运行中"
```

**运行循环**
```
每次轮询循环：
1. 帧开始标记
   ↓
2. 会话检测
   ↓
3. BUFF引擎执行
   ↓
4. 规则引擎执行  
   ↓
5. 旋转引擎执行
   ↓
6. 兜底技能检查
   ↓
7. 计数器更新
   ↓
8. 等待下次轮询
```

**停止流程**
```
停止触发：
- 热键再次按下
- 程序关闭命令
- 错误发生保护
- 会话模式激活

停止过程：
1. 停止轮询计时器
2. 解除热键绑定
3. 保存统计信息
4. 显示停止状态
5. 清理临时数据
```

### 状态管理

**运行状态**
- **已停止**: 初始状态，等待启动
- **运行中**: 正常执行轮询循环
- **暂停**: 会话模式或手动暂停
- **错误**: 发生错误时的保护状态

**状态提示**
```
状态显示：
- 图标变化: 红色→绿色→黄色
- 文字提示: "已停止"→"运行中"→"暂停"  
- 声音提示: 启动音、停止音、错误音
- 通知气泡: 系统托盘通知
```

## 性能优化

### 系统级优化

**CPU使用优化**
```
优化策略：
- 调整轮询间隔到合理范围
- 关闭不必要的功能模块
- 使用ROI优化减少取色范围
- 定期清理日志文件

性能指标：
- 轮询间隔25ms时CPU使用率 < 10%
- 技能识别准确率 > 95%
- 内存使用量 < 100MB
```

**内存管理**
```
优化方法：
- 定期重启长时间运行的程序
- 关闭不必要的后台程序
- 调整系统虚拟内存设置
- 使用高效的数据结构
```

### 配置级优化

**轮询间隔调优**
```
调整原则：
1. 硬件性能好的系统可以设置更短的间隔
2. 游戏类型决定最小可用间隔
3. 功能复杂度影响CPU使用率
4. 电源模式影响性能表现

测试方法：
1. 设置目标间隔
2. 运行5分钟观察CPU使用率
3. 检查技能响应是否及时
4. 根据结果微调间隔
```

**技能配置优化**
```
优化策略：
- 减少不必要的取色点
- 合理设置颜色容差
- 使用多线程分散负载
- 优化技能执行顺序
```

## 故障排除

### 常见问题

**问题1: 热键无反应**
```
可能原因：
- 热键与系统快捷键冲突
- 程序没有管理员权限
- 游戏窗口没有焦点
- 热键设置格式错误

解决方法：
1. 更换热键到不冲突的按键
2. 以管理员身份运行程序
3. 确保游戏窗口处于前台
4. 检查热键格式是否正确
```

**问题2: 轮询无法启动**
```
可能原因：
- 屏幕捕获环境不支持
- 游戏处于全屏独占模式
- 显卡驱动问题
- 权限不足

解决方法：
1. 切换到窗口化模式
2. 更新显卡驱动程序
3. 以管理员身份运行
4. 检查系统兼容性
```

**问题3: 统计数据异常**
```
可能原因：
- 计数器溢出
- 程序异常重启
- 数据同步问题
- 配置文件损坏

解决方法：
1. 重置所有计数器
2. 重新保存配置文件
3. 检查磁盘空间
4. 重新启动程序
```

### 调试方法

**日志分析**
```
重要日志文件：
- runtime.log: 运行时核心日志
- hotkeys.log: 热键操作日志  
- poller.log: 轮询执行日志
- counters.log: 计数器日志

日志级别：
- INFO: 正常运行信息
- WARN: 警告信息
- ERROR: 错误信息
```

**性能监控**
```
监控工具：
- Windows任务管理器
- 程序内置统计
- 第三方性能监控工具
- 系统资源监视器
```

## 最佳实践

### 配置建议

**热键设置**
1. **容易记忆**: 选择不常用的功能键
2. **避免冲突**: 确保不与游戏快捷键冲突  
3. **快速访问**: 放在手部容易触及的位置
4. **多重备份**: 设置备用热键作为应急方案

**轮询配置**
1. **循序渐进**: 从较长间隔开始逐步调优
2. **性能平衡**: 在响应速度和系统负载间找平衡
3. **游戏适配**: 根据游戏特性调整配置
4. **硬件考虑**: 考虑CPU和内存实际性能

**计数器使用**
1. **定期查看**: 每周查看统计数据
2. **趋势分析**: 观察各项指标的变化趋势
3. **问题诊断**: 通过异常数据发现问题
4. **性能优化**: 基于统计数据优化配置

### 安全使用

**运行监控**
- 定期检查程序运行状态
- 观察CPU和内存使用情况
- 注意游戏内的异常表现
- 及时停止有问题的运行

**配置备份**
- 定期备份工作正常的配置
- 保存多个版本的配置文件
- 记录重要的参数设置
- 准备回滚方案

**环境维护**
- 保持系统和驱动更新
- 维护良好的散热环境
- 确保电源供应稳定
- 定期清理系统垃圾

---

**注意**: 运行时模块直接控制宏的执行行为，请谨慎调整参数，建议先在测试环境中充分验证。